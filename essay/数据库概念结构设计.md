# 4.3 数据库设计

## 4.3.1 数据库概念结构设计

数据库概念结构设计是数据库设计的关键环节，它通过实体-联系（E-R）模型来描述现实世界的数据结构。本系统采用自顶向下的设计方法，首先识别系统中的所有实体，分析各实体的属性，然后确定实体间的联系，最后绘制全局E-R图。

### 1. 实体属性分析

根据系统需求分析和业务逻辑，本系统共识别出11个核心实体，具体如下：

#### （1）商品实体（Dish）

商品实体是系统的核心业务实体之一，用于描述校园外卖系统中的菜品信息。商品实体包含商品ID、商品名称、商品分类ID、商品价格、商品图片、商品描述、商品状态、创建时间、更新时间、创建人、修改人等属性，其中商品ID是主键。商品实体支持起售和停售两种状态，便于商家管理商品的上架和下架。商品分类ID作为外键关联到分类实体，用于标识商品所属的分类。商品价格采用decimal类型存储，精确到小数点后两位，确保价格计算的准确性。商品图片存储为URL地址，实际图片文件存储在阿里云OSS对象存储服务中，减轻服务器存储压力。商品实体属性图如图4.11所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│           商品实体 (Dish)            │
├─────────────────────────────────────┤
│  id (主键)                          │
│  name (商品名称)                     │
│  categoryId (分类ID)                 │
│  price (商品价格)                    │
│  image (商品图片)                    │
│  description (描述信息)              │
│  status (状态: 0停售 1起售)         │
│  createTime (创建时间)               │
│  updateTime (更新时间)               │
│  createUser (创建人)                 │
│  updateUser (修改人)                 │
└─────────────────────────────────────┘
```

#### （2）用户实体（User）

用户实体用于描述使用微信小程序进行订餐的学生用户信息。用户实体包含用户ID、微信OpenID、姓名、手机号、性别、身份证号、头像、注册时间等属性，其中用户ID是主键，OpenID是唯一标识。用户通过微信授权登录，系统自动获取微信用户信息，无需用户手动注册。OpenID是微信平台为用户分配的唯一标识符，用于识别不同用户，确保用户身份的唯一性。用户实体属性图如图4.12所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│           用户实体 (User)             │
├─────────────────────────────────────┤
│  id (主键)                          │
│  openid (微信用户唯一标识，唯一)     │
│  name (姓名)                        │
│  phone (手机号)                     │
│  sex (性别: 0女 1男)                │
│  idNumber (身份证号)                │
│  avatar (头像)                      │
│  createTime (注册时间)              │
└─────────────────────────────────────┘
```

#### （3）员工实体（Employee）

员工实体用于描述系统后台管理端的员工信息，包括管理员和普通员工。员工实体包含员工ID、用户名、密码、姓名、手机号、性别、身份证号、状态、创建时间、更新时间、创建人、修改人等属性，其中员工ID是主键，用户名是唯一标识。员工实体支持启用和禁用两种状态，便于管理员进行权限管理。员工密码采用MD5加密存储，确保密码安全性。创建人和修改人字段记录操作员工信息，便于追溯操作历史。员工实体属性图如图4.13所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│         员工实体 (Employee)           │
├─────────────────────────────────────┤
│  id (主键)                          │
│  username (用户名，唯一)             │
│  password (密码，MD5加密)            │
│  name (姓名)                        │
│  phone (手机号)                     │
│  sex (性别)                         │
│  idNumber (身份证号)                │
│  status (状态: 0禁用 1启用)         │
│  createTime (创建时间)              │
│  updateTime (更新时间)               │
│  createUser (创建人)                 │
│  updateUser (修改人)                 │
└─────────────────────────────────────┘
```

#### （4）分类实体（Category）

分类实体用于描述菜品和套餐的分类信息。分类实体包含分类ID、分类类型、分类名称、排序、状态、创建时间、更新时间、创建人、修改人等属性，其中分类ID是主键。分类类型分为菜品分类（type=1）和套餐分类（type=2），通过类型字段区分不同业务场景下的分类。排序字段用于控制分类在前端展示的顺序，数值越小越靠前。状态字段控制分类是否启用，禁用的分类不会在前端展示。分类实体属性图如图4.14所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│         分类实体 (Category)           │
├─────────────────────────────────────┤
│  id (主键)                          │
│  type (类型: 1菜品分类 2套餐分类)    │
│  name (分类名称)                    │
│  sort (排序)                        │
│  status (状态: 0禁用 1启用)         │
│  createTime (创建时间)              │
│  updateTime (更新时间)               │
│  createUser (创建人)                 │
│  updateUser (修改人)                 │
└─────────────────────────────────────┘
```

#### （5）菜品口味实体（DishFlavor）

菜品口味实体用于描述菜品的口味选项信息，如辣度、甜度等。菜品口味实体包含口味ID、菜品ID、口味名称、口味值列表等属性，其中口味ID是主键，菜品ID是外键关联到菜品实体。口味值以JSON格式存储，如["微辣","中辣","重辣"]，便于前端动态展示和用户选择。一个菜品可以有多个口味选项，例如一个菜品可以同时有"辣度"和"甜度"两个口味选项，每个口味选项又有多个可选值。菜品口味实体属性图如图4.15所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│       菜品口味实体 (DishFlavor)       │
├─────────────────────────────────────┤
│  id (主键)                          │
│  dishId (菜品ID，外键)              │
│  name (口味名称，如"辣度")          │
│  value (口味值列表，JSON格式)        │
└─────────────────────────────────────┘
```

#### （6）套餐实体（Setmeal）

套餐实体用于描述由多个菜品组合而成的套餐信息。套餐实体包含套餐ID、分类ID、套餐名称、套餐价格、状态、描述信息、图片、创建时间、更新时间、创建人、修改人等属性，其中套餐ID是主键，分类ID是外键关联到分类实体。套餐实体支持启用和停用两种状态，便于商家管理套餐的上架和下架。套餐价格是套餐的总价，套餐中包含的具体菜品及其数量通过套餐菜品关系实体进行关联。套餐实体属性图如图4.16所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│         套餐实体 (Setmeal)           │
├─────────────────────────────────────┤
│  id (主键)                          │
│  categoryId (套餐分类ID，外键)       │
│  name (套餐名称)                    │
│  price (套餐价格)                   │
│  status (状态: 0停用 1启用)         │
│  description (描述信息)             │
│  image (图片)                       │
│  createTime (创建时间)              │
│  updateTime (更新时间)               │
│  createUser (创建人)                 │
│  updateUser (修改人)                 │
└─────────────────────────────────────┘
```

#### （7）套餐菜品关系实体（SetmealDish）

套餐菜品关系实体用于描述套餐与菜品之间的多对多关系，记录套餐中包含的菜品及其数量。套餐菜品关系实体包含关系ID、套餐ID、菜品ID、菜品名称、菜品原价、份数等属性，其中关系ID是主键，套餐ID和菜品ID分别是外键。该实体实现了套餐与菜品之间的关联，支持一个套餐包含多个菜品，一个菜品也可以被多个套餐使用。菜品名称和菜品原价作为冗余字段存储，避免频繁关联查询菜品表，提升查询性能。份数字段表示该菜品在套餐中的数量。套餐菜品关系实体属性图如图4.17所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│    套餐菜品关系实体 (SetmealDish)     │
├─────────────────────────────────────┤
│  id (主键)                          │
│  setmealId (套餐ID，外键)           │
│  dishId (菜品ID，外键)              │
│  name (菜品名称，冗余字段)           │
│  price (菜品原价)                   │
│  copies (份数)                      │
└─────────────────────────────────────┘
```

#### （8）购物车实体（ShoppingCart）

购物车实体用于描述用户在微信小程序端选择的商品信息，是用户下单前的临时数据。购物车实体包含购物车ID、商品名称、用户ID、菜品ID、套餐ID、口味、数量、金额、图片、创建时间等属性，其中购物车ID是主键，用户ID是外键关联到用户实体。购物车实体支持同时存储菜品和套餐，通过菜品ID和套餐ID区分商品类型。当商品为菜品时，套餐ID为空；当商品为套餐时，菜品ID为空。口味字段存储用户选择的菜品口味信息，如"微辣"、"中辣"等。金额字段存储该购物车项的总金额，等于单价乘以数量。购物车实体属性图如图4.18所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│       购物车实体 (ShoppingCart)      │
├─────────────────────────────────────┤
│  id (主键)                          │
│  name (商品名称)                    │
│  userId (用户ID，外键)               │
│  dishId (菜品ID，外键，可为空)       │
│  setmealId (套餐ID，外键，可为空)    │
│  dishFlavor (口味)                  │
│  number (数量)                      │
│  amount (金额)                      │
│  image (图片)                       │
│  createTime (创建时间)              │
└─────────────────────────────────────┘
```

#### （9）订单实体（Orders）

订单实体是系统的核心业务实体，用于描述用户提交的订单信息。订单实体包含订单ID、订单号、订单状态、用户ID、地址ID、下单时间、结账时间、支付方式、支付状态、实收金额、备注、用户名称、手机号、地址、收货人、订单取消原因、订单拒绝原因、订单取消时间、预计送达时间、配送状态、送达时间、打包费、餐具数量、餐具数量状态、订单类型等属性，其中订单ID是主键，订单号是唯一标识。订单状态包括待付款（1）、待接单（2）、已接单（3）、派送中（4）、已完成（5）、已取消（6）、退款（7）等状态，完整记录了订单的生命周期。支付方式包括微信支付（1）和支付宝（2）。支付状态包括未支付（0）、已支付（1）、退款（2）。订单类型包括堂食自取（1）和外卖配送（2）。用户名称、手机号、地址、收货人等字段作为冗余字段存储，避免订单完成后因地址信息变更导致的历史订单信息丢失。订单实体属性图如图4.19所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│         订单实体 (Orders)            │
├─────────────────────────────────────┤
│  id (主键)                          │
│  number (订单号，唯一)               │
│  status (订单状态)                  │
│    1待付款 2待接单 3已接单          │
│    4派送中 5已完成 6已取消 7退款    │
│  userId (下单用户ID，外键)          │
│  addressBookId (地址ID，外键)        │
│  orderTime (下单时间)               │
│  checkoutTime (结账时间)            │
│  payMethod (支付方式: 1微信 2支付宝) │
│  payStatus (支付状态: 0未支付        │
│    1已支付 2退款)                   │
│  amount (实收金额)                 │
│  remark (备注)                      │
│  userName (用户名称)                │
│  phone (手机号)                     │
│  address (地址)                     │
│  consignee (收货人)                 │
│  cancelReason (订单取消原因)        │
│  rejectionReason (订单拒绝原因)     │
│  cancelTime (订单取消时间)          │
│  estimatedDeliveryTime (预计送达时间)│
│  deliveryStatus (配送状态)          │
│  deliveryTime (送达时间)            │
│  packAmount (打包费)                │
│  tablewareNumber (餐具数量)         │
│  tablewareStatus (餐具数量状态)     │
│  orderType (订单类型: 1堂食自取      │
│    2外卖配送)                       │
└─────────────────────────────────────┘
```

#### （10）订单明细实体（OrderDetail）

订单明细实体用于描述订单中包含的具体商品信息，一个订单可以包含多个订单明细。订单明细实体包含明细ID、名称、订单ID、菜品ID、套餐ID、口味、数量、金额、图片等属性，其中明细ID是主键，订单ID是外键关联到订单实体。订单明细实体支持同时记录菜品和套餐，通过菜品ID和套餐ID区分商品类型，并记录用户选择的口味信息。名称、金额、图片等字段作为冗余字段存储，记录下单时的商品信息快照，避免因商品信息变更导致的历史订单信息不准确。数量字段表示该商品在订单中的购买数量。金额字段存储该订单明细项的总金额。订单明细实体属性图如图4.20所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│      订单明细实体 (OrderDetail)      │
├─────────────────────────────────────┤
│  id (主键)                          │
│  name (商品名称)                    │
│  orderId (订单ID，外键)             │
│  dishId (菜品ID，外键，可为空)       │
│  setmealId (套餐ID，外键，可为空)    │
│  dishFlavor (口味)                  │
│  number (数量)                      │
│  amount (金额)                      │
│  image (图片)                       │
└─────────────────────────────────────┘
```

#### （11）地址簿实体（AddressBook）

地址簿实体用于描述用户的收货地址信息，支持用户管理多个收货地址。地址簿实体包含地址ID、用户ID、收货人、手机号、性别、省级区划编号、省级名称、市级区划编号、市级名称、区级区划编号、区级名称、详细地址、标签、是否默认等属性，其中地址ID是主键，用户ID是外键关联到用户实体。地址簿实体支持设置默认地址，便于用户快速选择常用地址。地址信息采用三级行政区划结构存储，包括省、市、区三级，便于地址的标准化管理和前端展示。标签字段用于标识地址的用途，如"家"、"学校"、"公司"等，方便用户识别和管理。是否默认字段标识该地址是否为用户的默认收货地址，用户下单时默认使用该地址。地址簿实体属性图如图4.21所示。

**实体属性图：**

```
┌─────────────────────────────────────┐
│       地址簿实体 (AddressBook)       │
├─────────────────────────────────────┤
│  id (主键)                          │
│  userId (用户ID，外键)               │
│  consignee (收货人)                 │
│  phone (手机号)                     │
│  sex (性别: 0女 1男)                │
│  provinceCode (省级区划编号)         │
│  provinceName (省级名称)             │
│  cityCode (市级区划编号)             │
│  cityName (市级名称)                 │
│  districtCode (区级区划编号)         │
│  districtName (区级名称)             │
│  detail (详细地址)                  │
│  label (标签，如"家"、"学校")        │
│  isDefault (是否默认: 0否 1是)      │
└─────────────────────────────────────┘
```

### 2. 实体间联系分析

#### （1）分类与商品之间的联系

一个分类可以包含多个商品，一个商品只能属于一个分类，因此分类与商品之间是一对多（1:N）的关系。联系属性包括分类ID（categoryId），该属性在商品实体中作为外键存在。

#### （2）商品与菜品口味之间的联系

一个商品可以有多个口味选项（如辣度、甜度等），一个口味选项只属于一个商品，因此商品与菜品口味之间是一对多（1:N）的关系。联系属性包括菜品ID（dishId），该属性在菜品口味实体中作为外键存在。

#### （3）分类与套餐之间的联系

一个分类可以包含多个套餐，一个套餐只能属于一个分类，因此分类与套餐之间是一对多（1:N）的关系。联系属性包括分类ID（categoryId），该属性在套餐实体中作为外键存在。

#### （4）套餐与商品之间的联系

一个套餐可以包含多个商品，一个商品可以被多个套餐使用，因此套餐与商品之间是多对多（M:N）的关系。该关系通过套餐菜品关系实体（SetmealDish）实现，联系属性包括套餐ID（setmealId）和菜品ID（dishId）。

#### （5）用户与订单之间的联系

一个用户可以下多个订单，一个订单只属于一个用户，因此用户与订单之间是一对多（1:N）的关系。联系属性包括用户ID（userId），该属性在订单实体中作为外键存在。

#### （6）订单与订单明细之间的联系

一个订单可以包含多个订单明细，一个订单明细只属于一个订单，因此订单与订单明细之间是一对多（1:N）的关系。联系属性包括订单ID（orderId），该属性在订单明细实体中作为外键存在。

#### （7）用户与地址簿之间的联系

一个用户可以拥有多个收货地址，一个地址只属于一个用户，因此用户与地址簿之间是一对多（1:N）的关系。联系属性包括用户ID（userId），该属性在地址簿实体中作为外键存在。

#### （8）订单与地址簿之间的联系

一个订单对应一个收货地址，一个地址可以被多个订单使用，因此订单与地址簿之间是多对一（N:1）的关系。联系属性包括地址ID（addressBookId），该属性在订单实体中作为外键存在。

#### （9）用户与购物车之间的联系

一个用户可以拥有多个购物车项，一个购物车项只属于一个用户，因此用户与购物车之间是一对多（1:N）的关系。联系属性包括用户ID（userId），该属性在购物车实体中作为外键存在。

#### （10）商品与购物车之间的联系

一个商品可以被多个用户加入购物车，一个购物车项可以对应一个商品，因此商品与购物车之间是一对多（1:N）的关系。联系属性包括菜品ID（dishId），该属性在购物车实体中作为外键存在。

#### （11）套餐与购物车之间的联系

一个套餐可以被多个用户加入购物车，一个购物车项可以对应一个套餐，因此套餐与购物车之间是一对多（1:N）的关系。联系属性包括套餐ID（setmealId），该属性在购物车实体中作为外键存在。

#### （12）商品与订单明细之间的联系

一个商品可以出现在多个订单明细中，一个订单明细可以对应一个商品，因此商品与订单明细之间是一对多（1:N）的关系。联系属性包括菜品ID（dishId），该属性在订单明细实体中作为外键存在。

#### （13）套餐与订单明细之间的联系

一个套餐可以出现在多个订单明细中，一个订单明细可以对应一个套餐，因此套餐与订单明细之间是一对多（1:N）的关系。联系属性包括套餐ID（setmealId），该属性在订单明细实体中作为外键存在。

### 3. 全局E-R图

全局E-R图展示了系统中所有实体及其之间的联系，具体如下：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          全局E-R图                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────┐                    ┌──────────────┐
│   分类实体    │                    │   员工实体   │
│  (Category)   │                    │ (Employee)   │
└──────┬───────┘                    └──────────────┘
       │                                    (独立实体，用于后台管理)
       │ 1
       │
       │ N
┌──────▼──────┐
│  商品实体   │                    ┌──────────────┐
│   (Dish)    │                    │   用户实体   │
└──────┬──────┘                    │   (User)     │
       │                            └──────┬───────┘
       │ 1                                  │
       │                                    │ 1
       │ N                                  │
┌──────▼──────────────┐                    │ N
│   菜品口味实体      │            ┌─────────▼──────────┐
│   (DishFlavor)      │            │    订单实体       │
└─────────────────────┘            │    (Orders)       │
                                   └─────────┬──────────┘
                                             │ 1
                                             │
                                             │ N
                                   ┌─────────▼──────────┐
                                   │   订单明细实体      │
                                   │  (OrderDetail)      │
                                   └─────────────────────┘

┌──────────────┐                            │
│  套餐实体    │                            │
│ (Setmeal)    │                            │
└──────┬───────┘                            │
       │                                    │
       │ 1                                  │
       │                                    │
       │ N                                  │
┌──────▼──────────────┐                    │
│   套餐菜品关系实体   │                    │
│    (SetmealDish)     │                    │
└──────────────────────┘                    │
                                             │
                                             │
                                   ┌─────────▼──────────┐
                                   │   购物车实体       │
                                   │ (ShoppingCart)     │
                                   └─────────────────────┘

                                             │
                                             │
                                   ┌─────────▼──────────┐
                                   │   地址簿实体       │
                                   │ (AddressBook)      │
                                   └─────────────────────┘

关系说明：
- 分类 ←→ 商品：1对N（一个分类包含多个商品）
- 分类 ←→ 套餐：1对N（一个分类包含多个套餐）
- 商品 ←→ 菜品口味：1对N（一个商品有多个口味选项）
- 套餐 ←→ 商品：M对N（通过套餐菜品关系实体实现）
- 用户 ←→ 订单：1对N（一个用户下多个订单）
- 用户 ←→ 地址簿：1对N（一个用户有多个地址）
- 用户 ←→ 购物车：1对N（一个用户有多个购物车项）
- 订单 ←→ 订单明细：1对N（一个订单包含多个明细）
- 订单 ←→ 地址簿：N对1（多个订单对应一个地址）
- 商品 ←→ 购物车：1对N（一个商品被多个用户加入购物车）
- 套餐 ←→ 购物车：1对N（一个套餐被多个用户加入购物车）
- 商品 ←→ 订单明细：1对N（一个商品出现在多个订单明细中）
- 套餐 ←→ 订单明细：1对N（一个套餐出现在多个订单明细中）
```

**E-R图说明：**

1. **分类实体**与**商品实体**、**套餐实体**之间都是一对多关系，一个分类可以包含多个商品或套餐。

2. **商品实体**与**菜品口味实体**之间是一对多关系，一个商品可以有多个口味选项。

3. **套餐实体**与**商品实体**之间是多对多关系，通过**套餐菜品关系实体**实现，一个套餐可以包含多个商品，一个商品也可以被多个套餐使用。

4. **用户实体**与**订单实体**、**地址簿实体**、**购物车实体**之间都是一对多关系，一个用户可以下多个订单、拥有多个地址、拥有多个购物车项。

5. **订单实体**与**订单明细实体**之间是一对多关系，一个订单可以包含多个订单明细。

6. **订单实体**与**地址簿实体**之间是多对一关系，一个订单对应一个收货地址。

7. **商品实体**和**套餐实体**与**购物车实体**、**订单明细实体**之间都是一对多关系，商品和套餐可以被多个用户加入购物车，也可以出现在多个订单明细中。

8. **员工实体**独立存在，用于系统后台管理，与其他业务实体无直接关联。

### 4. 总结

本系统的数据库概念结构设计共识别出11个核心实体，涵盖了用户管理、商品管理、订单管理、地址管理等核心业务功能。通过实体属性分析和E-R图设计，清晰地展现了系统中各实体之间的关系，为后续的数据库逻辑结构设计和物理结构设计奠定了基础。设计过程中严格遵循数据库设计规范，确保数据的完整性、一致性和可扩展性。

